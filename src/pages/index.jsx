import { useContext, useEffect, useState } from "react";
import Head from "next/head";
import axios from "axios";
import Overview from "../components/Home/Overview";
import Forecast from "../components/Home/Forecast";
import Loader from "../components/Loader";
import styles from "../styles/pages/Home.module.scss";
import { LocationContext } from "../contexts/locationContext";
import { WeatherContext } from "../contexts/WeatherContext";

const Home = () => {
    const { location } = useContext(LocationContext);
    const { weather, setWeather } = useContext(WeatherContext);

    // Fetch Weather from NEXT.js API

    useEffect(() => {
        const getWeather = async () => {
            try {
                const { data } = await axios.get("/api/weather", {
                    params: {
                        lat: location.geometry.lat,
                        lon: location.geometry.lng,
                    },
                });

                console.log("LOWL");

                setWeather({ ...data, fetchedOn: Date.now() });
            } catch (error) {
                console.log(error);
            }
        };

        ((!weather && location) ||
            (weather && Date.now() - weather.fetchedOn > 600000)) &&
            getWeather();
    }, [location]);

    return (
        <div className={styles.Home}>
            <Head>
                <title>MyWeather</title>
                <meta
                    name="description"
                    content="Generated by create next app"
                />
                <link rel="icon" href="/favicon.ico" />
            </Head>

            <main className={"Main " + styles.HomeMain}>
                {location ? (
                    <>
                        <Overview />
                        <Forecast />
                    </>
                ) : (
                    <Loader />
                )}
            </main>
        </div>
    );
};

export default Home;
